# Pipeline used to regenerate the cached test data
workflow:
  rules:
  - when: always

stages:
- generate
- publish

# Job template to regenerate some subset of the test data
.regen job:
  stage: generate
  needs:
  - pipeline: $PARENT_PIPELINE_ID
    job: 'deps: [amd64]'

  cache:
  - key: spack
    when: always
    paths: [.spack.git]
  - key: pkgs-$IMAGE_BASE
    when: always
    paths:
    - .pkg-cache/
  - key: ccache-$IMAGE_BASE$IMAGE_EXT-$JOB_CC
    when: always
    paths:
    - .ccache/

  variables:
    CCACHE_DIR: '$CI_PROJECT_DIR/.ccache'
    CCACHE_BASEDIR: '$CI_PROJECT_DIR'
    # Limit the ccache cache size to a modest level.
    # One HPCToolkit buildmany is ~2.5GB (~600MB compressed) over ~25000 files
    CCACHE_COMPRESS: 'true'
    CCACHE_MAXSIZE: '3G'
    CCACHE_MAXFILES: '30000'
    # OpenMPI refuses to run as user 0 without these options set.
    OMPI_ALLOW_RUN_AS_ROOT: 1
    OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
  before_script:
  # Make sure we have the basic set of utilities required to launch Spack and build stuff
  - >-
    ci/scripts/ensure-present.sh make git curl cc file patchelf python3 eatmydata
    py:boto3 py:clingo ${JOB_CC:+ccache} ${IMAGE_EXT:+py:podman} $extra_pkgs
  # Instantiate Spack
  - export SPACK_ROOT="$(realpath .spack)" PATH="$(realpath .spack)"/bin:"$PATH"
  - ci/dependencies/spack-init.sh
  script:
  - touch img-config
  # Generate a new batch of test data, and copy it back to the source tree
  - >-
    python3 -m ci.buildfe -l "logs/$CI_JOB_NAME" -a install-testdata
    img-config "ci/dependencies/latest;/spack/cenv/latest"
    --spack-no-install -1s "$SPEC"
  # Pack up the changes as a tarball for extraction
  - git ls-files --modified tests2/data/ > files.txt
  - tar -cJf "data.$SLUG.tar.xz" -T files.txt

  artifacts:
    paths:
    - logs/
    - data.*.tar.xz
    when: always


'regen testdata: [cpu]':
  extends: .regen job
  tags: [docker, linux/amd64]
  image: $DEPS_IMAGES-$IMAGE_BASE-$ARCH
  variables:
    IMAGE_BASE: ubuntu20.04
    ARCH: amd64
    JOB_CC: gcc-10
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl ~cuda ~rocm ~level0'
    SLUG: cpu

'regen testdata: [+cuda]':
  extends: .regen job
  services: &podman_service
  - name: quay.io/podman/stable
    entrypoint: ['/usr/bin/sudo', '-u', 'podman', 'podman', 'system', 'service', '-t', '0', 'tcp://0.0.0.0:7000']
    alias: podman
  image: docker.io/nvidia/cuda:11.6.2-devel-ubuntu20.04
  tags: [docker, linux/amd64, gpu/nvidia/usrspace:11.6, gpu/nvidia>6.0]
  variables:
    IMAGE_BASE: ubuntu20.04
    IMAGE_EXT: +cuda
    ARCH: amd64
    JOB_CC: gcc-9
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl +cuda ~rocm ~level0'
    SLUG: cuda
  before_script:
  - !reference [.regen job, before_script]
  # Pull CUDA from the image itself
  - echo '--with-cuda=/usr/local/cuda' > img-config
  # Pull dependencies from the base image
  - ci/scripts/podman-cp tcp://podman:7000 $DEPS_IMAGES-$IMAGE_BASE-$ARCH /spack

'regen testdata: [+rocm]':
  extends: .regen job
  services: *podman_service
  image: docker.io/rocm/dev-ubuntu-20.04:5.2.3
  tags: [docker, linux/amd64, gpu/amd/usrspace:5.2]
  variables:
    IMAGE_BASE: ubuntu20.04
    IMAGE_EXT: +rocm
    ARCH: amd64
    JOB_CC: gcc-9
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl ~cuda +rocm ~level0'
    SLUG: rocm
  before_script:
  - !reference [.regen job, before_script]
  # Pull ROCm from the image itself
  - echo '--with-rocm=/opt/rocm' > img-config
  # Pull dependencies from the base image
  - ci/scripts/podman-cp tcp://podman:7000 $DEPS_IMAGES-$IMAGE_BASE-$ARCH /spack


regen testdata:
  stage: publish
  image: registry.gitlab.com/hpctoolkit/ci-images/ubuntu20.04
  tags: [docker]
  needs:
  - 'regen testdata: [cpu]'
  - 'regen testdata: [+cuda]'
  - 'regen testdata: [+rocm]'
  script:
  # Unpack all the tarballs, in sequence
  - tar -xJf data.cuda.tar.xz
  - tar -xJf data.rocm.tar.xz
  - tar -xJf data.cpu.tar.xz
  # Repackage the changes as a new tarball for easy deployment
  - git ls-files --modified tests2/data/ > files.txt
  - tar -cJf "testdata.tar.xz" -T files.txt
  artifacts:
    expose_as: "Regenerated test data"
    paths:
    - testdata.tar.xz
