# Pipeline used to regenerate the cached test data
workflow:
  rules:
  - when: always

stages:
- generate
- publish

# Job template to regenerate some subset of the test data
.regen job:
  image: $DEPS_IMAGE_PREFIX-$OS_BASE$OS_EXT-$ARCH
  tags: [docker, linux/$ARCH]
  stage: generate
  cache:
  - key: pkgs-$IMAGE_BASE
    when: always
    paths:
    - .pkg-cache/
  - key: ccache-$IMAGE_BASE$IMAGE_EXT-$JOB_CC
    when: always
    paths:
    - .ccache/

  variables:
    CCACHE_DIR: '$CI_PROJECT_DIR/.ccache'
    CCACHE_BASEDIR: '$CI_PROJECT_DIR'
    # Limit the ccache cache size to a modest level.
    # One HPCToolkit buildmany is ~2.5GB (~600MB compressed) over ~25000 files
    CCACHE_COMPRESS: 'true'
    CCACHE_MAXSIZE: '3G'
    CCACHE_MAXFILES: '30000'
    # Some of the test data is stored in a submodule
    GIT_SUBMODULE_STRATEGY: recursive
    # OpenMPI refuses to run as user 0 without these options set.
    OMPI_ALLOW_RUN_AS_ROOT: 1
    OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
  before_script:
  - ccache --zero-stats
  after_script:
  - ccache --zero-stats
  script:
  # Generate a new batch of test data, saved to the logs/ dir
  - >-
    dev buildfe -d /spack/cenv/latest -- -l "logs/$CI_JOB_NAME" -a fresh-testdata-"$SUITE"
    --fail-fast $OS_BUILDFE_ARGS -1s "$SPEC"
  - mv logs/"$CI_JOB_NAME"/*/fresh-"$SUITE".tar.xz logs/fresh-"$SUITE".tar.xz

  artifacts:
    paths:
    - logs/
    when: always


'none':
  extends: .regen job
  variables:
    OS_BASE: ubuntu20.04
    ARCH: amd64
    JOB_CC: gcc-10
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl ~cuda ~rocm ~level0'
    SUITE: none

'cpu':
  extends: .regen job
  variables:
    OS_BASE: ubuntu20.04
    ARCH: amd64
    JOB_CC: gcc-10
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl ~cuda ~rocm ~level0'
    SUITE: cpu

'x86-64':
  extends: .regen job
  variables:
    OS_BASE: ubuntu20.04
    ARCH: amd64
    JOB_CC: gcc-10
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl ~cuda ~rocm ~level0'
    SUITE: x86-64

'nvidia':
  extends: .regen job
  tags: [docker, linux/$ARCH, gpu/nvidia/usrspace:11.6, gpu/nvidia>6.0]
  variables:
    OS_BASE: ubuntu20.04
    OS_EXT: -cuda11.6.2
    OS_BUILDFE_ARGS: '-C--with-cuda=/usr/local/cuda'
    ARCH: amd64
    JOB_CC: gcc-9
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl +cuda ~rocm ~level0'
    SUITE: nvidia

'sw-cuda':
  extends: .regen job
  variables:
    OS_BASE: ubuntu20.04
    OS_EXT: -cuda11.8.0
    OS_BUILDFE_ARGS: '-C--with-cuda=/usr/local/cuda'
    ARCH: amd64
    JOB_CC: gcc-9
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl +cuda ~rocm ~level0'
    SUITE: sw-cuda

'amd':
  extends: .regen job
  tags: [docker, linux/amd64, gpu/amd/usrspace:5.2]
  variables:
    OS_BASE: ubuntu20.04
    OS_EXT: -rocm5.2.3
    OS_BUILDFE_ARGS: '-C--with-rocm=/opt/rocm'
    ARCH: amd64
    JOB_CC: gcc-9
    SPEC: '+tests2 +mpi ~debug +papi +python ~opencl ~cuda +rocm ~level0'
    SUITE: amd


package:
  stage: publish
  image: docker.io/alpine
  tags: [docker]
  variables:
    GIT_SUBMODULE_STRATEGY: none
  script:
  - apk add xz
  - mkdir /tmp/result
  # Unpack all the tarballs to the temporary directory
  - tar x -af logs/fresh-none.tar.xz -C /tmp/result
  - tar x -af logs/fresh-cpu.tar.xz -C /tmp/result
  - tar x -af logs/fresh-nvidia.tar.xz -C /tmp/result
  - tar x -af logs/fresh-amd.tar.xz -C /tmp/result
  - tar x -af logs/fresh-x86-64.tar.xz -C /tmp/result
  - tar x -af logs/fresh-sw-cuda.tar.xz -C /tmp/result
  # Repack into a single tarball
  - tar c -Jf testdata.tar.xz -C /tmp/result .
  artifacts:
    expose_as: "Regenerated test data"
    paths:
    - testdata.tar.xz
