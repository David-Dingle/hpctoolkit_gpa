#!/bin/sh -ex

hpctesttool="$1"
hpcrun="$2"
tstexe_cuda_vecadd="$3"
event="$4"
trace="$5"

case "$trace" in
"")
  threads=1
  tracearg=--no-trace
  ;;
-t|-tt)
  threads=2
  tracearg=--trace
  ;;
*)
  exit 2
  ;;
esac

trap 'rm -rf "$tmpdir"' EXIT
tmpdir=$(mktemp --directory --tmpdir=.)

# shellcheck disable=SC2086
"$hpcrun" -o "$tmpdir"/m -e "$event" -ck HPCRUN_CUPTI_SYSTEM_ERROR_EXITCODE=77 $trace "$tstexe_cuda_vecadd"
"$hpctesttool" test produces-profiles -t "$threads" "$tracearg" "$tmpdir"/m
