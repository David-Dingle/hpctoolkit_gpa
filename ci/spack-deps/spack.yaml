spack:
  config:
    install_tree:
      root: /opt/software
      padded_length: 256
    source_cache: /mnt/cache/spack-src

  view: false
  concretizer:
    unify: true
    reuse: false

  definitions:
  # Core dependencies. These specs should stay in-sync with subprojects/spack-deps/spack.yaml
  - core:
    - >-
      boost @1.71.0:
      +atomic +date_time +filesystem +system +thread +timer +graph +regex +chrono
      +shared +multithreaded visibility=global
    - 'bzip2 @1.0.8:'
    - 'elfutils ~nls @0.186:'
    - 'intel-tbb +shared @2020.3'
    - 'libmonitor +hpctoolkit ~dlopen @2023.03.15:'
    - 'xz @5.2.5:5.2.6,5.2.10:'
    - 'zlib +shared @1.2.13:1.2'
    - 'libunwind +xz @1.6.2:'
    - 'libpfm4 @4.11.0:'
    - 'xerces-c transcoder=iconv @3.2.3:'
    - 'libiberty +pic @2.37:'
    - 'yaml-cpp +shared @0.7.0:'
  - when: env["VERMODE"] != "bare"
    core:
    - 'xxhash @0.8.1:'
  - when: env["VERMODE"] == "minimum"
    core:
    - boost @1.71.0
    - bzip2 @1.0.8
    - elfutils @0.186
    - intel-tbb @2020.3
    - libmonitor @2023.03.15
    - xz @5.2.5
    - zlib @1.2.13
    - libunwind @1.6.2
    - libpfm4 @4.11.0
    - xerces-c @3.2.3
    - libiberty @2.37
    - yaml-cpp @0.7.0
    - xxhash @0.8.1
  # Optional dependencies.
  - optional: []
  - when: env["VERMODE"] != "bare"
    optional:
    - 'papi @6.0.0.1:'  # Required for -Dpapi=enabled
    - 'opencl-c-headers @2022.01.04:'  # Required for -Dopencl=enabled
  - when: env["VERMODE"] == "minimum"
    optional:
    - papi @6.0.0.1
    - opencl-c-headers @2022.01.04

  specs:
  - $core
  - $optional

  packages:
    all:
      # NB: These requirements must be anchor-copied to all packages with custom requires
      require:
      # We only concretize for generic targets
      - &target {any_of: ['target=:x86_64', 'target=:aarch64', 'target=:ppc64le']}
      # Do not allow infinity versions, we only build full "point" releases
      - &noinf '@:999999999'

    libevent:
      require:
      - *target
      - *noinf
      # Workaround for https://github.com/spack/spack/issues/41056
      - spec: '^libtool @2.4.6'

  mirrors:
    upstream-cache:
      url: oci://registry.gitlab.com/hpctoolkit/hpctoolkit/spack-buildcache/v0.21
      binary: true
      source: false

    spack-binaries:
      url: https://binaries.spack.io/develop
      binary: true
      source: false
